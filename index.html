<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Sky キャンドル計算機</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- フォント -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Roboto:wght@100;300&family=Noto+Sans+JP:wght@100;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic&display=swap" rel="stylesheet">

<style>
/* ================================
   全体スタイル
================================ */
body {
  font-family: 'Baloo 2', cursive;
  background: linear-gradient(135deg, #fdfbff 0%, #eef5ff 40%, #fdf6ff 100%);
  margin: 0;
  padding: 24px 12px 260px;
  color: #222;
  position: relative;
}
.app {
  max-width: 960px;
  margin: 0 auto;
}

/* ================================
   タイトル
================================ */
.page-title-wrapper {
  width: 100%;
  text-align: right;
  margin-bottom: 20px;
  line-height: 1.15;
  user-select: none;
}
.page-title-line {
  font-family: 'Roboto', sans-serif;
  font-weight: 100;
  font-size: 32px;
  letter-spacing: 0.04em;
}
.page-title-line:first-child {
  font-size: 22px;
  opacity: 0.9;
}

/* ================================
   カテゴリカード
================================ */
.category {
  background:#fff;
  border-radius:24px;
  padding:18px 22px 16px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(70,90,150,0.22);
  border:2px solid rgba(210,220,255,0.9);
}
.category-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:12px;
  user-select: none;
}
.category-left {
  display:flex;
  align-items:center;
  gap:1px;
}
.category-label {
  font-family: 'Sawarabi Gothic', 'Noto Sans JP', sans-serif;
  font-size:24px;
  font-weight:500;
  position: relative;
  top: -2px;
}

/* ================================
   カテゴリトグル（四角 → 丸）
================================ */
.category-toggle {
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 2px solid #ff9b42;
  background: #fff;
  cursor: pointer;
  position: relative;
  transition:
    background 0.25s ease,
    box-shadow 0.25s ease,
    border-color 0.25s ease;
}
.category-toggle:checked {
  background: radial-gradient(circle, #ffb36b 0%, #ff9b42 70%);
  border-color: #ff9b42;
  box-shadow: 0 0 6px rgba(255,150,50,0.6);
}
.category-toggle:checked {
  animation: catPop 0.25s ease-out;
}
@keyframes catPop {
  0%   { transform: scale(0.6); opacity: 0.4; }
  60%  { transform: scale(1.15); opacity: 1; }
  100% { transform: scale(1.0); opacity: 1; }
}

/* pill タグ */
.category-title {
  display:flex;
  align-items:center;
  gap:10px;
}
.category-sum {
  display:inline-block;
  font-size:14px;
  padding:3px 12px;
  border-radius:999px;
  font-weight:600;
  background:linear-gradient(145deg, rgba(250,252,255,0.8), rgba(235,242,255,0.8));
  border:1px solid rgba(150,170,255,0.55);
  color:#3a6cff;
  box-shadow:
    0 2px 6px rgba(70,100,200,0.15),
    inset 0 0 4px rgba(255,255,255,0.6);
  transition: opacity .25s ease, transform .25s ease, box-shadow .25s ease;
}
.category-sum.flash {
  opacity:0.9;
  transform:scale(1.12);
  box-shadow:
    0 0 14px rgba(120,150,255,0.45),
    inset 0 0 6px rgba(255,255,255,0.8);
}

/* アイテムグリッド */
.items {
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:8px;
}

/* チェックボックス */
.check-wrapper {
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(248,251,255,0.95);
  border:1px solid rgba(185,211,255,0.6);
  transition: background .25s, border-color .25s;
  user-select: none;
}
.check-input {
  display:none !important;
}
.check-wrapper.checked {
  background:rgba(255,200,120,0.25);
  border-color:rgba(255,160,60,0.8);
}

/* アイテム名 */
.item-name {
  flex:1;
  font-family: 'Sawarabi Gothic', 'Noto Sans JP', sans-serif !important;
  font-weight: 400;
  font-size: 18px;
  letter-spacing: 0.2px;
  white-space:nowrap;
}

/* 数値 */
.item-value {
  font-size:12px;
  font-weight:400;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(61,138,255,0.08);
  border:1px solid rgba(61,138,255,0.25);
}

/* ================================
   日曜日スイッチ
================================ */
.sunday-toggle-container{
  display:flex;
  align-items:center;
  gap:8px;
}
.sunday-label-text {
  font-size:16px;
  font-family: 'Sawarabi Gothic', 'Noto Sans JP', sans-serif;
  position: relative;
  top: -1px;
}
.sunday-switch {
  position: relative;
  width: 60px;
  height: 32px;
  display: inline-block;
}
.sunday-switch input {
  display: none;
}
.sunday-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #cfd3da;
  border-radius: 32px;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.15);
  transition: background 0.25s ease, box-shadow 0.25s ease;
}
.sunday-slider::before {
  content: "";
  position: absolute;
  width: 26px;
  height: 26px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: transform 0.22s cubic-bezier(0.22, 0.61, 0.36, 1), box-shadow 0.22s ease;
}
.sunday-switch input:checked + .sunday-slider {
  background: linear-gradient(135deg, #4cd964, #3ac569);
  box-shadow:
    inset 0 0 0 rgba(0,0,0,0),
    0 0 6px rgba(76,217,100,0.6);
}
.sunday-switch input:checked + .sunday-slider::before {
  transform: translateX(28px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.35);
}

/* ================================
   合計カード（固定）
================================ */
#southPanel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 14px 16px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(12px);
  box-shadow: 0 -4px 18px rgba(60,80,150,0.25);
  border-top: 1px solid rgba(150,170,240,0.9);
  z-index: 1000;
}

#total {
  font-size: 22px;
  font-weight: 700;
  color: #2d3a80;
  font-family:'Noto Sans JP',sans-serif;
}

#required {
  font-size:18px;
  font-weight:700;
  color:#000;
  font-family:'Noto Sans JP',sans-serif;
}

/* デイリーライン（スマホ） */
.daily-list {
  display:none;
  font-size:13px;
  margin-top:4px;
}

/* スマホ用しきい値ラベル */
.sp-threshold-label {
  font-size: 12px;
  color: #333;
  margin-right: 6px;
}
.sp-threshold-label-highlight {
  font-size: 16px;
  color: #d33;
  font-weight: 700;
}

/* 光アニメ */
.sp-glow {
  animation: spGlow 0.7s ease-in-out;
}
@keyframes spGlow {
  0% { filter: brightness(1); text-shadow:0 0 0px rgba(255,100,100,0); }
  50%{ filter: brightness(1.7); text-shadow:0 0 12px rgba(255,120,120,1); }
  100%{ filter: brightness(1); text-shadow:0 0 0px rgba(0,0,0,0); }
}

/* ================================
   ゲージ
================================ */
.gauge-wrapper {
  margin-top:6px;
  margin-bottom:6px;
  position:relative;
}
.gauge-track {
  position:relative;
  height:18px;
  border-radius:999px;
  background:#d0d0d0;
  border:1px solid #aaa;
  overflow:hidden;
}
.gauge-fill {
  position:absolute;
  top:0; left:0;
  width:0%;
  height:100%;
  background:linear-gradient(180deg,#afc9f0,#3787ff);
  transition:width 0.4s ease-out;
  z-index:2;
}
#gaugeMarker {
  position:absolute;
  top:-20px;
  transform:translateX(-50%);
  width:44px;
  height:44px;
  pointer-events:none;
  z-index:5;
  transition:left 0.4s ease-out 0.05s;
}
#gaugeMarker img {
  width:44px;
}

/* メモリ線 */
.gauge-segment {
  position:absolute;
  width:2px;
  height:10px;
  bottom:-6px;
  background:rgba(80,80,80,0.45);
  border-radius:2px;
  z-index:3;
}
.gauge-segment.major {
  width:3px;
  height:16px;
  bottom:-8px;
  background:rgba(30,30,30,0.9);
}

/* 上側ラベル */
#topLabelLayer {
  position:fixed;
  left:0;
  top:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
  z-index:5000;
}
.gauge-top-label {
  position:absolute;
  font-size:12px;
  color:#000;
  font-weight:700;
  transform:translateX(-50%);
  white-space:nowrap;
}

/* 下側ラベル */
#bottomLabelLayer {
  position:absolute;
  left:0;
  top:100%;
  width:100%;
  pointer-events:none;
  z-index:4000;
}
.bottom-gauge-label {
  position:absolute;
  font-size:14px;
  color:#000;
  font-weight:700;
  transform:translateX(-50%);
  white-space:nowrap;
}

/* ゲージ光 */
@keyframes flashGauge {
  0% { box-shadow: 0 0 0px rgba(255,255,255,0); filter: brightness(1); }
  50%{ box-shadow: 0 0 16px rgba(255,255,255,0.9); filter: brightness(1.8); }
  100%{ box-shadow: 0 0 0px rgba(255,255,255,0); filter: brightness(1); }
}
.gauge-fill.flash {
  animation: flashGauge 0.45s ease-out;
}
@keyframes markerFlash {
  0% { filter: brightness(1); }
  50%{ filter: brightness(1.8) drop-shadow(0 0 8px rgba(255,255,200,0.9)); }
  100%{ filter: brightness(1); }
}
#gaugeMarker.flash {
  animation: markerFlash 0.45s ease-out;
}

/* ================================
   ボタン
================================ */
.button-group{
  display:flex;
  gap:8px;
}
#resetButton,
#undoButton {
  padding:8px 18px;
  border-radius:999px;
  color:white;
  border:none;
  cursor:pointer;
  font-weight:700;
  white-space: nowrap;
}
#resetButton {
  background:linear-gradient(135deg,#ff8b8b,#ff6b6b);
}
#undoButton {
  background:linear-gradient(135deg,#8bb4ff,#6b8dff);
}

/* 下段 */
.south-bottom-row {
  margin-top:30px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

/* ================================
   スマホ最適化
================================ */
@media (max-width:480px){

  .category-label {
    font-size:16px !important;
    top:-1px;
  }

  .south-bottom-row > div:first-child {
    flex: 1;
    min-width: 0;
    overflow: hidden;
  }

  #required { display:none; }

  #dailyList {
    white-space: nowrap;
    overflow-x: auto;
    max-width: 100%;
  }

  #resetButton,
  #undoButton {
    flex-shrink: 0;
    font-size: 14px;
  }

  .items {
    grid-template-columns:repeat(2,minmax(0,1fr)) !important;
  }

  .gauge-top-label{
    display:none !important;
  }

  .daily-list{
    display:block !important;
  }

  .item-name {
    font-size:14px !important;
  }
}

@media (min-width:481px) and (max-width:768px){
  .items {
    grid-template-columns:repeat(3,minmax(0,1fr)) !important;
  }
  .daily-list{
    display:none !important;
  }
}

@media (min-width:769px){
  .items {
    grid-template-columns:repeat(4,minmax(0,1fr));
  }
  .daily-list{
    display:none;
  }
}
</style>
</head>


<body>
<div class="app">

  <!-- タイトル -->
  <div class="page-title-wrapper">
    <div class="page-title-line">Sky: Children of the Light</div>
    <div class="page-title-line">Candle Calculator</div>
  </div>

  <!-- カテゴリカードが入る -->
  <div id="mainPanel"></div>

  <!-- 画面下固定の合計パネル -->
  <div id="southPanel">
    <div id="total">合計: 0 （0キャンドル）</div>

    <div class="gauge-wrapper">
      <div class="gauge-track" id="gaugeTrack">
        <div class="gauge-fill" id="gaugeFill"></div>
      </div>

      <div id="gaugeMarker">
        <img src="candle.png" alt="candle">
      </div>

      <div id="bottomLabelLayer"></div>
    </div>

    <div class="south-bottom-row">
      <div>
        <div id="required">デイリーライト: <b>2055（15本）</b></div>
        <div id="dailyList" class="daily-list"></div>
      </div>

      <div class="button-group">
        <button id="resetButton">全てリセット</button>
        <button id="undoButton" style="display:none;">元に戻す</button>
      </div>
    </div>
  </div>

</div>

<!-- 上側ラベル（2055, 2268...） -->
<div id="topLabelLayer"></div>



<script>
/* ===================
   データ
=================== */
const categories = ["孤島","草原","雨林","峡谷","捨てられた地","書庫","その他","ソーシャル"];
const items = [
  ["砂丘","予言者の石窟","水の試練","土の試練","風の試練","火の試練"],
  ["蝶々の住処","草原の村","洞窟","8人エリア","鳥の巣","楽園の島々"],
  ["開拓地","小川","神殿前","高台広場","神殿","ツリーハウス","地下洞窟"],
  ["スロープ","陸レース","要塞","空レース","コロセウム","神殿","夢見の町","隠者","隠者レース"],
  ["倒壊した祠","墓地","戦場","座礁船","箱舟","秘宝"],
  ["１階","２階","３階","４階","最上部","保存庫","資料庫","星月夜の砂漠","オフィス"],
  ["花鳥郷","ホーム","シナモン","大キャン4","大キャン4","風の街道"],
  ["パン屋","パン屋2","ウニ焼き","ウニ焼き2","闇の欠片"]
];

const values = [
  [200,50,100,105,200,200],
  [55,119,45,99,50,299],
  [45,227,175,42,83,55,57],
  [104,135,79,150,10,93,100,50,215],
  [65,92,111,63,109,188],
  [69,110,12,222,64,31,50,140,57],
  [23,23,50,200,200,80],
  [540,540,300,300,200]
];

const sundayValues = [
  [200,50,100,105,200,200],
  [55,119,45,99,50,299],
  [45,227,175,42,83,55,57],
  [104,135,79,150,10,93,100,50,215],
  [86,119,139,101,109,188],
  [69,110,12,222,64,31,50,140,57],
  [23,23,50,200,200,80],
  [540,540,300,300,200]
];

/* キャンドル到達値 */
const candleThresholds = [
  {max:93,candles:0},{max:187,candles:1},{max:281,candles:2},{max:375,candles:3},
  {max:469,candles:4},{max:608,candles:5},{max:747,candles:6},{max:886,candles:7},
  {max:1025,candles:8},{max:1164,candles:9},{max:1342,candles:10},{max:1520,candles:11},
  {max:1698,candles:12},{max:1876,candles:13},{max:2054,candles:14},{max:2267,candles:15},
  {max:2480,candles:16},{max:2718,candles:17},{max:3206,candles:18},{max:4194,candles:19},
  {max:Infinity,candles:20}
];

const thresholdMap = {
  15:2055,16:2268,17:2481,18:2719,19:3207,20:4195
};

/* 日曜日モード */
let activeValues = values;
let sundayMode = false;
const SUNDAY_MODE_KEY = "sky_candle_sunday_mode";

/* DOM */
const mainPanel = document.getElementById("mainPanel");
const totalLabel = document.getElementById("total");
const gaugeFill = document.getElementById("gaugeFill");
const gaugeMarker = document.getElementById("gaugeMarker");
const gaugeTrack = document.getElementById("gaugeTrack");
const topLabelLayer = document.getElementById("topLabelLayer");
const bottomLabelLayer = document.getElementById("bottomLabelLayer");
const resetButton = document.getElementById("resetButton");
const undoButton = document.getElementById("undoButton");
const dailyListEl = document.getElementById("dailyList");

let checkBoxes = [];
let categorySumTags = [];
let lastCandles = 0;
let undoState = null;
let sundaySwitchInput = null;

/* ===============================
   メモリ線生成
================================ */
for(let i=1;i<=19;i++){
  const mem=document.createElement("div");
  mem.classList.add("gauge-segment");
  mem.style.left=(i/20*100)+"%";
  if(i===5||i===10||i===15) mem.classList.add("major");
  gaugeTrack.appendChild(mem);
}

/* ===============================
   カテゴリ生成
================================ */
categories.forEach((cat,i)=>{
  const card=document.createElement("div");
  card.className="category";

  const head=document.createElement("div");
  head.className="category-header";

  const leftBox=document.createElement("div");
  leftBox.className="category-left";

  const toggle=document.createElement("input");
  toggle.type="checkbox";
  toggle.className="category-toggle";

  toggle.addEventListener("change",()=>{
    items[i].forEach((_,j)=>{
      const cb=checkBoxes[i][j];
      cb.checked=toggle.checked;
      localStorage.setItem(cb.id,cb.checked);
      cb.parentElement.classList.toggle("checked",cb.checked);
    });
    updateTotal();
    updateCategoryTotals();
  });

  const titleWrap=document.createElement("div");
  titleWrap.className="category-title";

  const label=document.createElement("span");
  label.className="category-label";
  label.textContent=cat;

  const sumTag=document.createElement("span");
  sumTag.className="category-sum";
  sumTag.textContent="(+0)";
  categorySumTags[i]=sumTag;

  titleWrap.appendChild(label);
  titleWrap.appendChild(sumTag);

  leftBox.appendChild(toggle);
  leftBox.appendChild(titleWrap);
  head.appendChild(leftBox);

  /* 捨てられた地の右端に日曜日トグル */
  if(i===4){
    const sundayContainer = document.createElement("div");
    sundayContainer.className = "sunday-toggle-container";

    const text = document.createElement("span");
    text.className = "sunday-label-text";
    text.textContent = "日曜日";

    const sundayWrap=document.createElement("label");
    sundayWrap.className="sunday-switch";

    const sunInput=document.createElement("input");
    sunInput.type="checkbox";
    sunInput.id="sundayToggle";

    const slider=document.createElement("span");
    slider.className="sunday-slider";

    sundayWrap.appendChild(sunInput);
    sundayWrap.appendChild(slider);

    sundayContainer.appendChild(text);
    sundayContainer.appendChild(sundayWrap);
    head.appendChild(sundayContainer);

    sundaySwitchInput = sunInput;

    sunInput.addEventListener("change",()=>{
      sundayMode = sunInput.checked;
      localStorage.setItem(SUNDAY_MODE_KEY, sundayMode);
      applySundayMode();
    });
  }

  card.appendChild(head);

  const list=document.createElement("div");
  list.className="items";

  checkBoxes[i]=[];

  items[i].forEach((name,j)=>{
    const wrap=document.createElement("label");
    wrap.className="check-wrapper";

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="check-input";
    cb.id=`cb_${i}_${j}`;
    cb.dataset.value=activeValues[i][j];
    cb.checked=localStorage.getItem(cb.id)==="true";

    cb.addEventListener("change",()=>{
      localStorage.setItem(cb.id,cb.checked);
      wrap.classList.toggle("checked",cb.checked);
      updateTotal();
      updateCategoryTotals();
    });

    const ns=document.createElement("span");
    ns.className="item-name";
    ns.textContent=name;

    const vs=document.createElement("span");
    vs.className="item-value";
    vs.textContent=`+${cb.dataset.value}`;

    wrap.appendChild(cb);
    wrap.appendChild(ns);
    wrap.appendChild(vs);
    list.appendChild(wrap);

    checkBoxes[i][j]=cb;
  });

  card.appendChild(list);
  mainPanel.appendChild(card);
});

/* ===============================
   キャンドル数計算
================================ */
function getCandleCount(t){
  for(const x of candleThresholds){
    if(t<=x.max) return x.candles;
  }
  return 0;
}

/* ===============================
   ゲージ更新
================================ */
function updateGauge(c){
  const ratio = c / 20;

  if (c > lastCandles) {
    gaugeFill.classList.add("flash");
    setTimeout(()=>gaugeFill.classList.remove("flash"),450);
    gaugeMarker.classList.add("flash");
    setTimeout(()=>gaugeMarker.classList.remove("flash"),450);
  }

  gaugeFill.style.width = (ratio * 100) + "%";
  gaugeMarker.style.left = (ratio * 100) + "%";

  lastCandles = c;
}

/* ===============================
   Reset ボタンの文字更新（スマホのみ）
================================ */
function updateResetButtonLabel() {
  const isMobile = window.matchMedia("(max-width: 480px)").matches;
  resetButton.textContent = isMobile ? "リセット" : "全てリセット";
}

/* ===============================
   合計計算（パン屋カンスト対応）
================================ */
function updateTotal(){
  let total=0;

  // パン屋カンスト処理
  const p1=checkBoxes[7][0];
  const p2=checkBoxes[7][1];

  const v1=parseInt(p1.dataset.value,10);
  const v2=parseInt(p2.dataset.value,10);

  let panyaSum=0;
  if(p1.checked) panyaSum+=v1;
  if(p2.checked) panyaSum+=v2;

  const cappedPanya=Math.min(panyaSum,1000);

  checkBoxes.forEach(row=>{
    row.forEach(cb=>{
      if(cb.checked) total += parseInt(cb.dataset.value,10);
    });
  });

  total = total - panyaSum + cappedPanya;

  // パン屋2 表示切替
  const p2Label = p2.parentElement.querySelector(".item-value");
  if(p1.checked && p2.checked){
    p2Label.textContent = "+460";
    p2Label.style.color = "red";
    p2Label.style.fontWeight = "700";
  } else {
    p2Label.textContent = `+${v2}`;
    p2Label.style.color = "";
    p2Label.style.fontWeight = "";
  }

  const c=getCandleCount(total);
  totalLabel.innerHTML=`合計: ${total} （${c}キャンドル）`;

  updateGauge(c);

  // ★ スマホしきい値更新
  updateDailyList();
}

/* ===============================
   カテゴリ小計更新
================================ */
function updateCategoryTotals(){
  categories.forEach((cat,i)=>{
    let sum=0;
    checkBoxes[i].forEach(cb=>{
      if(cb.checked) sum+=parseInt(cb.dataset.value,10);
    });

    const tag=categorySumTags[i];
    const newText=`(+${sum})`;

    if(tag.textContent!==newText){
      tag.textContent=newText;
      tag.classList.add("flash");
      setTimeout(()=>tag.classList.remove("flash"),250);
    }
  });
}

/* ===============================
   上側ラベル配置（PC用）
================================ */
function placeTopLabels(){
  topLabelLayer.innerHTML="";
  const rect=gaugeTrack.getBoundingClientRect();
  const topY=rect.top-24;

  for(let c=15;c<=20;c++){
    const v=thresholdMap[c];
    const label=document.createElement("div");
    label.className="gauge-top-label";
    label.textContent=v;

    const px=rect.left + rect.width*(c/20);
    label.style.left=px+"px";
    label.style.top=topY+"px";

    topLabelLayer.appendChild(label);
  }
}

/* ===============================
   下側ラベル配置（0,5,10,15,20）
================================ */
function placeBottomLabels(){
  bottomLabelLayer.innerHTML="";

  for(const n of [0,5,10,15,20]){
    const ratio = n / 20;
    const label=document.createElement("div");
    label.className="bottom-gauge-label";
    label.textContent=n;
    label.style.left = (ratio * 100) + "%";
    label.style.top = "0px";
    bottomLabelLayer.appendChild(label);
  }
}

/* ===============================
   ★ スマホ用デイリーリスト（2055 → 2268 → … → 灰キャン）
================================ */
function updateDailyList(){
  const isMobile=window.matchMedia("(max-width: 480px)").matches;
  if(!isMobile){
    dailyListEl.textContent="";
    return;
  }

  // 合計値の再取得（updateTotal の totalLabel とは別管理）
  let total=0;
  checkBoxes.forEach(row=>{
    row.forEach(cb=>{
      if(cb.checked) total += parseInt(cb.dataset.value,10);
    });
  });

  // パン屋反映は updateTotal の中ですでに調整済みなのでここはシンプルでOK

  const thresholds = [
    { base: 2055, next: 2268, candle: 15 },
    { base: 2268, next: 2481, candle: 16 },
    { base: 2481, next: 2719, candle: 17 },
    { base: 2719, next: 3207, candle: 18 },
    { base: 3207, next: 4195, candle: 19 }
  ];

  let baseText = "";
  let nextText = "";
  let glow = false;

  // 4195以上 → 灰キャン
  if (total >= 4195){
    baseText = `4195（20本）`;
    nextText = `灰キャン`;
    glow = true;
  } else {
    let found = false;

    for (let t of thresholds){
      if(total < 2055){
        baseText = `2055（15本）`;
        nextText = `2268（16本）`;
        found = true;
        break;
      }

      if(total >= t.base && total < t.next){
        baseText = `${t.base}（${t.candle}本）`;
        nextText = `${t.next}（${t.candle+1}本）`;
        glow = true;
        found = true;
        break;
      }
    }

    if(!found){
      baseText = `3207（19本）`;
      nextText = `4195（20本）`;
      glow = true;
    }
  }

  // HTML生成
  dailyListEl.innerHTML = `
    <span class="sp-threshold-label-highlight ${glow ? "sp-glow" : ""}">
      ${baseText}
    </span>
    <span style="font-size:14px; color:#000; margin:0 6px;">➡</span>
    <span class="sp-threshold-label">${nextText}</span>
  `;
}

/* ===============================
   wrapクリックでトグル
================================ */
function applyWrapToggle(){
  checkBoxes.forEach(row=>{
    row.forEach(cb=>{
      const wrap=cb.parentElement;
      wrap.classList.toggle("checked",cb.checked);

      wrap.addEventListener("click",()=>{
        cb.checked=!cb.checked;
        localStorage.setItem(cb.id,cb.checked);
        wrap.classList.toggle("checked",cb.checked);
        updateTotal();
        updateCategoryTotals();
      });
    });
  });
}

/* ===============================
   Undo 状態管理
================================ */
function snapshotState(){
  return checkBoxes.map(row => row.map(cb => cb.checked));
}

function restoreState(state){
  checkBoxes.forEach((row,i)=>{
    row.forEach((cb,j)=>{
      const checked = state[i][j];
      cb.checked = checked;
      localStorage.setItem(cb.id, checked);
      cb.parentElement.classList.toggle("checked", checked);
    });
  });

  document.querySelectorAll(".category-toggle").forEach((toggle,i)=>{
    const allChecked = state[i].every(v=>v);
    toggle.checked = allChecked;
  });

  updateTotal();
  updateCategoryTotals();
  placeTopLabels();
  placeBottomLabels();
  updateDailyList();
}

function updateUndoButton(){
  undoButton.style.display = undoState ? "inline-block" : "none";
}

/* ===============================
   日曜日モード適用
================================ */
function applySundayMode(){
  activeValues = sundayMode ? sundayValues : values;

  categories.forEach((cat,i)=>{
    items[i].forEach((name,j)=>{
      const cb = checkBoxes[i][j];
      const v  = activeValues[i][j];
      cb.dataset.value = v;
      const vs = cb.parentElement.querySelector(".item-value");
      vs.textContent = `+${v}`;
    });
  });

  updateTotal();
  updateCategoryTotals();
}

/* ===============================
   リセット
================================ */
resetButton.onclick=()=>{
  undoState = snapshotState();
  updateUndoButton();

  checkBoxes.forEach(row=>row.forEach(cb=>{
    cb.checked=false;
    localStorage.setItem(cb.id,false);
    cb.parentElement.classList.remove("checked");
  }));

  document.querySelectorAll(".category-toggle").forEach(a=>a.checked=false);

  updateTotal();
  updateCategoryTotals();
  placeTopLabels();
  placeBottomLabels();
  updateDailyList();
};

/* ===============================
   Undo
================================ */
undoButton.onclick=()=>{
  if(!undoState) return;
  restoreState(undoState);
  undoState = null;
  updateUndoButton();
};

/* ===============================
   初期表示
================================ */
window.addEventListener("load",()=>{

  const savedMode = localStorage.getItem(SUNDAY_MODE_KEY);
  if(savedMode === "true"){
    sundayMode = true;
    if(sundaySwitchInput){
      sundaySwitchInput.checked = true;
    }
  }
  applySundayMode();

  updateTotal();
  updateCategoryTotals();
  placeTopLabels();
  placeBottomLabels();
  updateDailyList();
  applyWrapToggle();
  updateUndoButton();
  updateResetButtonLabel();
});

/* ===============================
   リサイズ時
================================ */
window.addEventListener("resize",()=>{
  placeTopLabels();
  placeBottomLabels();
  updateDailyList();
  updateResetButtonLabel();
});
</script>

</body>
</html>
